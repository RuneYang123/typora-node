### 一、Hadoop简介

#### 1、Hadoop定义

Hadoop是apache算开发的分布式系统基础架构，解决海量数据的储存和分析计算问题。通常广泛的说是hadoop生态圈（hdfs，mr，yarn等）。

#### 2、Hadoop优势

高可靠性：存储数据会生成多个副本。

高拓展性：Hadoop可动态增加机器。

高效性：Hadoop是并行计算工作的。

高容错性：能够将失败的任务重新分配。

#### 3、Hadoop组成

Hadoop1：Common（辅助工具）、hdsf（数据储存)、mr（包括计算和资源调度）。

hadoop2：和1增加了yarn专门用作资源调度。

### 二、HDFS（分布式文件存储系统）简介

#### 1、HDFS优缺点

优点：高容错性，能够将失败的任务重新分配，适合大数据开发，可以构建在廉价机器上。

缺点：不适合低延时时间数据访问，无法对大量小文件进行储存，小文件寻址时间会超过读取时间，不支持并发写入，文件随意修改，经支持追加。

#### 2、HDFS架构

NameNode（nn）：就是Master，管理HDFS的名称空间，配置副本策略，管理数据块的映射信息，处理客户端读写请求。

DataNode（dn）：储存实际的数据块，执行数据块的读写操作。

SecondaryNameNode：当NN挂掉，他不能马上代替提供服务，分担nn数据。

Client：文件切分，文件上传的时候，将文件切分。与nn交互，获取文件位置，与dn交互，读写文件。管理文件，进行增上改查。

#### 3、文件块大小

HDFS文件分块储存的，默认128M。寻址时间为传输时间的1%则最佳。文件快

块太小会增加寻址时间，块太大导致磁盘传输数据时间会大于定位这个块的时间，处理时间长。

#### 4、常用shell操作

基本hadoop fs或者hdfs dfs。

```
hadoop fs -mkdir /sanguo //创建
```

### 三、HDFS文件读写流程

#### 1、写数据流程

1、客户端准备数据，（分布式文件系统）。

2、向NN请求上传数据，NN检查权限以及文件是否已经存在。

3、NN响应可以上传文件。

4、client请求上传第一个block，请NN返回DM。

5、返回dn1，dn2，dn3节点，用这三个节点储存数据。

6、请求建立block传输通道，（边读边写边传）

7、chunk512B+4b 等到64K是形成一个paket。

#### 2、读数据流程

1、client请求下载文件，

2、判断权限，以及文件是否存在。然后返回文件元数据。

3、根据元数据，读取文件最近的文件（考虑负载均衡）。

4、串行读文件，一一读取。

### 四、NN以及2NN

#### 1、nn工作机制

1、加载编辑日志和镜像文件到内存。

2、元数据的操作请求。

3、记录操作日志和流程，更新滚动日志。

4、内存数据更改。

#### 2、2nn工作机制

1、请求是否需要NNcheckpoint，触发条件（定时时间到，Edits日志文件数据满了）

2、请求执行checkpoint

3，滚动正在写的Edits。

4、镜像文件以及Edits拷贝到2NN。

5、加载到内存并合并，生成新的镜像文件，拷贝到NN。

6、重命名镜像文件。

#### 3、Fsimage镜像文件和Edits编辑日志

1、Fsimage镜像文件：是文件元数据的永久性检查点，其中包含HDFS的所有目录和文件的序列化的信息。

2、Edits编辑日志：存放文件系统的所有更新操作的路径，文件系统客户端执行的所有写操作首先会被记录到Edits文件中。

3、seen_txid：当前最新文件数据

### 四、MR简介

#### 1、MR优点

1、易于编程，框架有大量默认代码

2、良好的拓展性，可动态增加服务器

3、高容错性任何一台机器挂了，可转移给其他的节点。

4、适合海量数据计算

#### 2、MR缺点

1、不擅长实时计算

2、不擅长流式计算

3、不擅长DAG有向无环图

### 五、MR编程思想

#### 1、核心思想

1、MR一般分为Map过程和Reduce过程。

2、Map阶段并发，互不相干。

3、reduce阶段的并发，互不相关，他们依赖于map结果。

#### 2、MR编程规范

##### 1、Mapper阶段

1、用户定义Mapper要继承自己的父类。

2、Mapper的输入数据是KV对的形式

3、Mapper的业务逻辑在Map中

4、输出也是KV对的形式

5、map方法对每一个KV调用一次

##### 2、reducer阶段

1、用户定义reducer要继承自己的父类。

2、reducer的输入KV对应Map的输出

3、reducer的业务逻辑在reducer中

4、reduce方法对相同的K调用一次reduce（）。

##### 1、diver阶段

相当于yarn客户端，用于提交我们整个程序到yarn集群，提交封装的mr程序相关运行参数的job对象。

### 六、MR框架原理

#### 1.切片与MapTask

MapTask的个数，决定了并行度。 切片是逻辑上的存储，物理上对数据并不切割。MapTask的个数，是由切片决定，默认情况下切片128M。切片时不考虑数据集整体，每次文件单独切片。

#### 2、MR工作流程

1、对文件切片分析。客户端准备切片，jar包，job.xml。

2、计算出MapTask数量。
